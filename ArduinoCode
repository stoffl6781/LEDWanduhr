/*
 * code used to turn on a LED when an hour arm hit the respective seconds number
 * a led is attached to each number
 * 
 * use following library:
 * https://github.com/jarzebski/Arduino-DS3231
 * 
 * this code work as:
 * 1. Turn on the digit corresponding to the current hour and remain on unless next hour
 * 2. Turn on and remain on for 5 minutes, when a minute arm touch it
 * 3. Turn on and remain on for 5 seconds, when a second arm touch it
 * 
*/

#include <Wire.h>
#include <DS3231.h>

#define first_led_pin 23
#define last_led_pin 45


DS3231 clock;
RTCDateTime dt;

//array store the number of leds connected
const char led[] = {45, 23, 25, 27, 29, 31, 33, 35, 37, 39, 41, 43};

// other variables
unsigned char current_h_led, current_m_led,current_s_led, last_hour;
unsigned int h_index,m_index,s_index,h,m,s,i;


void init_variables(){ 
  /*
   * Function initialize the current leds and make them high
  */
  unsigned int offset;
  dt = clock.getDateTime();

  // calculate the index base on current time for led array
  h_index = (dt.hour)%12;
  m_index = (int)((dt.minute)/5);
  s_index = (int)((dt.second)/5);

  // extracting curent led number from array
  current_h_led = led[h_index];
  current_m_led = led[m_index];
  current_s_led = led[s_index];

  digitalWrite(current_h_led, HIGH);
  digitalWrite(current_m_led, HIGH);
  digitalWrite(current_s_led, HIGH);

  // storing current hour,min and sec to be used in main loop
  h = h_index;
  m = m_index;
  s = s_index;
}

void setup()
{
  Serial.begin(9600);
  
  // Initialize DS3231
  Serial.println("Initialize DS3231");
  
  clock.begin();
  
  // Set sketch compiling time
  clock.setDateTime(__DATE__, __TIME__);
  //clock.setDateTime(2018, 7, 31, 0, 0, 0);

  // making leds ouput
   for (int i = first_led_pin; i <= last_led_pin ; i += 2 ) {
    pinMode(i, OUTPUT);    // set pins as outputs
    digitalWrite(i, LOW);  // switch the output pins off
  }
  
  init_variables();
}

void loop()
{
  //reading values
    dt = clock.getDateTime();
  
  // calculating index
    h_index = (dt.hour)%12;
    m_index = (int)((dt.minute)/5);
    s_index = (int)((dt.second)/5);
  
  // extracting led values based on time
    current_h_led = led[h_index];
    current_m_led = led[m_index];
    current_s_led = led[s_index];

// in order to avoid operation repeatedly we used if statement
    if( (h_index != h) || (m_index != m) || (s_index != s) ){
      // stroing current index for next iteration
      h = h_index;
      m = m_index;
      s = s_index;

      // if an index changed then make it low 
       for ( i = first_led_pin; i <= last_led_pin ; i += 2 ) {
        if ((led[h_index] == i) || (led[m_index] == i) || (led[s_index] == i)){
            digitalWrite(i,HIGH);
            Serial.print("seconds: ");Serial.println(dt.second);
            Serial.print("LED: ");Serial.println(i);
            //continue;
          }
          else{
        digitalWrite(i, LOW);  // switch the output pins off
      }
     }
                  
    }
}
